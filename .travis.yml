language: cpp
sudo: required
dist: trusty
  
python:
  - "2.7"

compiler:
  - gcc

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
      - llvm-toolchain-precise
    packages:
      - cmake
      - valgrind
      - gcc-5
      - g++-5
      - clang-format-5.0

before_install:
  - sudo apt-get update
  # OpenCV dependencies - Details available at: http://docs.opencv.org/trunk/doc/tutorials/introduction/linux_install/linux_install.html
  - sudo apt-get install -y build-essential
  - sudo apt-get install -y cmake git libgtk2.0-dev pkg-config libavcodec-dev libavformat-dev libswscale-dev
  - sudo apt-get install -y python-dev python-numpy libtbb2 libtbb-dev libjpeg-dev libpng-dev libtiff-dev libjasper-dev libdc1394-22-dev

install:
  - sudo pip2 install lizard -q # Cyclomatic Complexity Check Tool
  - sudo unlink /usr/bin/gcc && sudo ln -s /usr/bin/gcc-5 /usr/bin/gcc # Change symlinks of gcc to gcc-5
  - sudo unlink /usr/bin/g++ && sudo ln -s /usr/bin/g++-5 /usr/bin/g++ # Change symlinks of g++ to g++-5

  # Download v3.4.1 .zip file and extract.
  - curl -sL https://github.com/Itseez/opencv/archive/3.4.1.zip > opencv.zip
  - unzip opencv.zip
  
  # Download EXTRA MODULES and extract.
  - curl -sL https://github.com/Itseez/opencv_contrib/archive/3.4.1.zip > opencv_contrib.zip
  - unzip opencv_contrib.zip
  
  # Create a new 'build' folder.
  - cd opencv-3.4.1
  - mkdir build
  - cd build
  
  # Set build instructions for Ubuntu distro.
  -  cmake -D OPENCV_EXTRA_MODULES_PATH= ../../opencv_contrib-3.4.1/modules -D WITH_TBB=ON -D INSTALL_C_EXAMPLES=ON -D WITH_EIGEN=OFF -D BUILD_EXAMPLES=ON -D WITH_QT=ON -D WITH_OPENGL=ON ..

  # Run 'make'
  - make
  
  # Install to OS.
  - sudo make install
  
  # Add configuration to OpenCV to tell it where the library files are located on the file system (/usr/local/lib)
  - sudo sh -c 'echo "/usr/local/lib" > /etc/ld.so.conf.d/opencv.conf'
  
  - sudo ldconfig
  - echo "OpenCV installed."
  
  # We need to return to the repo "root" folder, so we can then 'cd' into the C++ project folder.
  - cd ../../

before_script:
  - gcc --version
  - g++ --version
  - python --version
  - cmake --version
  - valgrind --version
  - lizard --version

script: 
  - source .fetch-build-environment.sh ~/build-environment/
  - source test.sh
  - cmake CMakeLists.txt
  - make
  - ./a.out
